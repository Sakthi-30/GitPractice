search.sp

ALTER PROCEDURE PRFXCONTRACTSEARCH
(
	@ROWUSERCODE			INT
	,@CONTRACTAPPLICATION	VARCHAR(30)		= NULL
	,@BANKACCOUNT			INT				= NULL
	,@SORTBY                VARCHAR(100)    = NULL
    ,@SORTDIRECTION         TINYINT         = NULL
    ,@PAGENUMBER            INT
    ,@PAGESIZE              INT
    ,@RESULTCOUNT           INT OUTPUT
    ,@TOTALPAGECOUNT        INT OUTPUT
)
AS
BEGIN
	SET NOCOUNT ON;
    DECLARE @ROWFROM BIGINT;
    DECLARE @ROWTO BIGINT; 
    DECLARE @TEMPTABLE TABLE (FLDFXCONTRACTID UNIQUEIDENTIFIER, FLDROWNUMBER BIGINT IDENTITY(1,1));
 
    SET @SORTDIRECTION = ISNULL(@SORTDIRECTION, 0);

	INSERT INTO @TEMPTABLE (FLDFXCONTRACTID)
    SELECT FLDFXCONTRACTID
    FROM TBLFXCONTRACT  (NOLOCK)
    WHERE 
        (@CONTRACTAPPLICATION IS NULL OR FLDCONTRACTAPPLICATION LIKE '%' + @CONTRACTAPPLICATION + '%')
        AND (@BANKACCOUNT IS NULL OR FLDBANKACCOUNT = @BANKACCOUNT)

	SET @RESULTCOUNT = @@ROWCOUNT;
    SET @TOTALPAGECOUNT = DBO.FNTOTALPAGECOUNT(@RESULTCOUNT, @PAGESIZE);
    SET @ROWFROM = DBO.FNROWFROM(@PAGENUMBER, @PAGESIZE);
    SET @ROWTO = DBO.FNROWTO(@PAGENUMBER, @PAGESIZE);
 
    SELECT 
        E.FLDFXCONTRACTID			
		,E.FLDCONTRACTAPPLICATION	
		,E.FLDFXCONTRACT			
		,E.FLDEXCHANGERATE		
		,E.FLDBANKACCOUNT			
		,E.FLDBANKACCOUNTCURRENCY	
		,E.FLDPAYMENTCURRENCY		
		,E.FLDCREATEDDATE			
		,E.FLDCREATEDBY			
		,E.FLDMODIFIEDDATE		
		,E.FLDMODIFIEDBY			
		,E.FLDDTKEY				

    FROM @TEMPTABLE T
    LEFT JOIN TBLFXCONTRACT E (NOLOCK) ON T.FLDFXCONTRACTID = E.FLDFXCONTRACTID
    WHERE T.FLDROWNUMBER BETWEEN @ROWFROM AND @ROWTO
    ORDER BY T.FLDROWNUMBER;
 
END;





insert.sp

CREATE PROCEDURE PRFXCONTRACTINSERT
(
	@ROWUSERCODE				INT
	,@CONTRACTAPPLICATION		VARCHAR(30)		
	,@FXCONTRACT				VARCHAR(30)		
	,@EXCHANGERATE				DECIMAL(9,7)	
	,@BANKACCOUNT				INT				
	,@BANKACCOUNTCURRENCY		VARCHAR(30)		
	,@PAYMENTCURRENCY			INT				
)
AS
BEGIN

	SET NOCOUNT ON
 
	DECLARE @FXCONTRACTID	UNIQUEIDENTIFIER
	SELECT @FXCONTRACTID = NEWID()

	INSERT INTO TBLFXCONTRACT
	(
		FLDFXCONTRACTID			
		,FLDCONTRACTAPPLICATION	
		,FLDFXCONTRACT			
		,FLDEXCHANGERATE		
		,FLDBANKACCOUNT			
		,FLDBANKACCOUNTCURRENCY	
		,FLDPAYMENTCURRENCY		
		,FLDCREATEDDATE			
		,FLDCREATEDBY			
		,FLDMODIFIEDDATE		
		,FLDMODIFIEDBY			
	)
	
	OUTPUT 0, @ROWUSERCODE, GETUTCDATE(), OBJECT_NAME(@@PROCID), NULL,INSERTED.* INTO TBLAUDITFXCONTRACT

	VALUES
	(
		@FXCONTRACTID		
		,@CONTRACTAPPLICATION	
		,@FXCONTRACT			
		,@EXCHANGERATE		
		,@BANKACCOUNT			
		,@BANKACCOUNTCURRENCY	
		,@PAYMENTCURRENCY	
		,GETUTCDATE()
		,@ROWUSERCODE
		,GETUTCDATE()
		,@ROWUSERCODE
	)
END





edit.sp

CREATE PROCEDURE PRFXCONTRACTEDIT
(
	@FXCONTRACTID	UNIQUEIDENTIFIER
)
AS
BEGIN
	SELECT
	FLDFXCONTRACTID
	,FLDFXCONTRACT
	,FLDPAYMENTCURRENCY
	FROM TBLFXCONTRACT
	WHERE @FXCONTRACTID = FLDFXCONTRACTID
END

SELECT * FROM TBLFXCONTRACT





update.sp

CREATE PROCEDURE PRFXCONTRACTUPDATE
(
	  @ROWUSERCODE			INT
	  ,@FXCONTRACTID		UNIQUEIDENTIFIER
	  ,@FXCONTRACT			VARCHAR(30)
	  ,@PAYMENTCURRENCY		INT		
)
AS
BEGIN
	UPDATE TBLFXCONTRACT SET 

			FLDFXCONTRACT	 = @FXCONTRACT
			,FLDPAYMENTCURRENCY	 = @PAYMENTCURRENCY

	OUTPUT 1, @ROWUSERCODE, GETUTCDATE(), OBJECT_NAME(@@PROCID),NULL,  INSERTED.* INTO TBLAUDITFXCONTRACT

	WHERE FLDFXCONTRACTID = @FXCONTRACTID
END

select * from TBLFXCONTRACT where FLDFXCONTRACTID ='30fb8d21-316b-4aab-9ce7-025f652382c9'







delete.sp

CREATE PROCEDURE PRFXCONTRACTDELETE
(
	  @ROWUSERCODE	INT
	 ,@FXCONTRACTID	UNIQUEIDENTIFIER
)
AS
BEGIN
	DELETE FROM TBLFXCONTRACT
	OUTPUT 2, @ROWUSERCODE, GETUTCDATE(), OBJECT_NAME(@@PROCID), NULL, DELETED.* INTO TBLAUDITFXCONTRACT
	WHERE FLDFXCONTRACTID = @FXCONTRACTID
END








TABLE

CREATE TABLE TBLFXCONTRACT
(
	FLDFXCONTRACTID				UNIQUEIDENTIFIER
	,FLDCONTRACTAPPLICATION		VARCHAR(30)				NOT NULL
	,FLDFXCONTRACT				VARCHAR(30)				NOT NULL
	,FLDEXCHANGERATE			DECIMAL(9,7)			NOT NULL
	,FLDBANKACCOUNT				INT						NOT NULL
	,FLDBANKACCOUNTCURRENCY		VARCHAR(30)				NOT NULL
	,FLDPAYMENTCURRENCY			INT						NOT NULL
	,FLDCREATEDDATE				DATETIME				NOT NULL
	,FLDCREATEDBY				INT						NOT NULL
	,FLDMODIFIEDDATE			DATETIME				NOT NULL
	,FLDMODIFIEDBY				INT						NOT NULL
	,FLDDTKEY					UNIQUEIDENTIFIER		CONSTRAINT DF_TBLFXCONTRACT_FLDDTKEY DEFAULT(NEWSEQUENTIALID())
)





AUDIT

CREATE TABLE TBLAUDITFXCONTRACT
(
	 FLDAUDITTYPE				TINYINT					NULL
	,FLDAUDITUSERCODE			INT						NULL
	,FLDAUDITDATETIME			DATETIME				NULL
	,FLDAUDITPROCEDURE			VARCHAR (128)			NULL
	,FLDAUDITTRANSFERDATE		DATETIME				NULL
	,FLDFXCONTRACTID			UNIQUEIDENTIFIER
	,FLDCONTRACTAPPLICATION		VARCHAR(30)				NOT NULL
	,FLDFXCONTRACT				VARCHAR(30)				NOT NULL
	,FLDEXCHANGERATE			DECIMAL(9,7)			NOT NULL
	,FLDBANKACCOUNT				INT						NOT NULL
	,FLDBANKACCOUNTCURRENCY		VARCHAR(30)				NOT NULL
	,FLDPAYMENTCURRENCY			INT						NOT NULL
	,FLDCREATEDDATE				DATETIME				NOT NULL
	,FLDCREATEDBY				INT						NOT NULL
	,FLDMODIFIEDDATE			DATETIME				NOT NULL
	,FLDMODIFIEDBY				INT						NOT NULL
	,FLDDTKEY					UNIQUEIDENTIFIER		NOT NULL
)
